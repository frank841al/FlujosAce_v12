BROKER SCHEMA pe.com.bbva.ace.bolsa



CREATE PROCEDURE loadCacheParameter (IN cacheServices REFERENCE,
									 IN inService CHARACTER,
									 IN nameOperation CHARACTER,
									 IN refEnv REFERENCE)
BEGIN
	
	--En caso el cache del servicio no este activo, se carga la parametria del servicio
	--Declaracion de variables
	DECLARE errorConfig BOOLEAN FALSE;
	DECLARE errorCode INTEGER 0; 
	DECLARE errorMsg CHARACTER ''; 
	DECLARE rowsParamService ROW;
	DECLARE rowsParamOpe ROW;
	DECLARE rowsParamGeneric ROW;
	DECLARE rowsOpe ROW;
	DECLARE rowsMap ROW;
	DECLARE rowsUsr ROW;
	DECLARE rowEnvironment 	ROW;
	
	--Carga parametria del Servicio
	CALL SP_GET_PARAMETER_SERVICE   	(inService		, rowsParamService.Config[]);  
	CALL SP_GET_PARAMETER_SERVICE		(getSERVGEN()	, rowsParamGeneric.Config[]);
	CALL SP_GET_MAPEO 					(inService		, rowsMap.Config[]);  
	CALL SP_GET_OPERATION 				(inService		, rowEnvironment.Operations[]);
	CALL SP_GET_PARAMETER_OPERATION		(inService		, rowEnvironment.TableParameterOperation[]);
			
	CREATE FIELD rowsUsr.usr.Operacion;
	CREATE FIELD rowsUsr.usr.Parametros;
	CREATE FIELD rowsUsr.usr.Parametros.Map;
	CREATE FIELD rowsUsr.usr.ParametrosGenericos;
	CREATE FIELD rowsUsr.usr.ParametrosOperacion;
	CREATE FIELD rowsUsr.usr.AddHeaderOperacion;
	
	CREATE FIELD refEnv.Operation;
	CREATE FIELD refEnv.ParamOperation;
	
		
	DECLARE refParam 			REFERENCE TO rowsUsr.usr.Parametros;
	DECLARE refParamGen 		REFERENCE TO rowsUsr.usr.ParametrosGenericos;
	DECLARE refParamOperation 	REFERENCE TO rowsUsr.usr.ParametrosOperacion;
	DECLARE refOperation 		REFERENCE TO rowsUsr.usr.Operacion; 
	SET rowsOpe.Tabla[] = (SELECT	P.CODE_OPERATION,
									P.NAME,
									P.CONDITIONAL,
									P.ROUTE_CONDITIONAL,
									P.CODE_SERVICE,
									P.INPUT
									FROM rowEnvironment.Operations[] as P
									WHERE P.CODE_SERVICE = inService AND
										  P.STATUS = 'A'
									);
	
	SET rowsParamOpe.Config[] =	(SELECT	P.CODE_SERVICE,
										P.CODE_OPERATION,
										P.ATTRIBUTE,
										P.VALUE,
										P.STATUS_PARAMETER,
										P.STATUS_OPERATION,
										P.STATUS_SERVICE
								 FROM rowEnvironment.TableParameterOperation[] as P
								 WHERE P.CODE_SERVICE = inService  AND
									  P.STATUS_PARAMETER = 'A' AND P.STATUS_OPERATION = 'A' AND
									  P.STATUS_SERVICE = 'A'
								 );

	CALL crearNombreCampos (rowsParamService	, refParam);
	CALL crearNombreCampos (rowsParamGeneric	, refParamGen);		
	CALL crearNombreCampos (rowsParamOpe		, refParamOperation);
	
	SET refParam.Map	= rowsMap.Config[1];
	SET refOperation	= rowsOpe.Tabla[1];
	--Validaciones de parametria del HUB     
	IF inService = '' OR inService IS NULL THEN
		SET errorCode = 1000; 
		SET errorMsg  = 'No se envio el codigo de servicio';		 
	ELSEIF CARDINALITY(rowsParamService.Config[]) < 1 THEN
		SET errorCode = 1001;
		SET errorMsg  = 'El servicio ' || inService || ' no tiene parametros asignados';
	ELSEIF LENGTH(refParam.LEVEL_AUDIT) < 4 THEN
		SET errorCode = 1003; 
		SET errorMsg  = 'El servicio ' || inService || ' tiene mal configurado el nivel de auditoria'; 
	ELSEIF CARDINALITY(rowsOpe.Tabla[]) < 1 THEN
		SET errorCode = 1007; 
		SET errorMsg  = 'El servicio ' || inService || ' no contiene operaciones'; 
	ELSEIF CARDINALITY(rowsParamOpe.Config[]) < 1 THEN
		SET errorCode = 1001; 
		SET errorMsg  = 'La operacion ' || nameOperation || ' del servicio ' || inService || ' no tiene parametros asignados'; 
	ELSEIF CARDINALITY(rowsMap.Config[]) < 1 THEN
		SET errorCode = 1004; 
		SET errorMsg  = 'El servicio ' || inService || ' no tiene una mapa a seguir'; 
	END IF;
	
		
	SET cacheServices.{"inService"}.Header.usr 			= rowsUsr.usr;	
	SET cacheServices.{"inService"}.validate.errorCode  = errorCode;
	SET cacheServices.{"inService"}.validate.errorMsg 	= errorMsg;
	SET cacheServices.{"inService"}.Map 				= rowsMap;
	SET cacheServices.{"inService"}.Operation 	    	= rowsOpe;
	SET cacheServices.{"inService"}.ParamOperation 		= rowsParamOpe;
	SET cacheServices.{"inService"}.iniciado 			= TRUE; 
END;



/*
 * Procedimiento para obtener el template x Operacion de un servicio
 */
CREATE PROCEDURE SP_GET_PARAMETER_SERVICE (IN COD_SERVICE CHARACTER)
LANGUAGE DATABASE
DYNAMIC RESULT SETS 1
EXTERNAL NAME "HUBACE.PKG_CONTROL.SP_GET_PARAMETER_SERVICE";


/*
 * Procedimiento para obtener los paarametros de una operacion por servicio
*/
CREATE PROCEDURE SP_GET_PARAMETER_OPERATION (IN COD_SERVICE CHARACTER)
LANGUAGE DATABASE
DYNAMIC RESULT SETS 1
EXTERNAL NAME "HUBACE.PKG_CONTROL.SP_GET_PARAMETER_OPERATION";


/*
 * Procedimiento para obtener agregar parametros a la cabecera por REST
*/
CREATE PROCEDURE SP_ADD_HEADER_OPERATION (IN COD_SERVICE CHARACTER)
LANGUAGE DATABASE
DYNAMIC RESULT SETS 1
EXTERNAL NAME "HUBACE.PKG_CONTROL.SP_ADD_HEADER_OPERATION";


/*
 * Procedimiento para obtener las operaciones por servicio
 */
CREATE PROCEDURE SP_GET_OPERATION (IN COD_SERVICE CHARACTER)
LANGUAGE DATABASE
DYNAMIC RESULT SETS 1
EXTERNAL NAME "HUBACE.PKG_CONTROL.SP_GET_OPERATION";


/*
 * Procedimiento para obtener el mapeo de un servicio
 */
CREATE PROCEDURE SP_GET_MAPEO (IN COD_SERVICE CHARACTER)
LANGUAGE DATABASE
DYNAMIC RESULT SETS 1
EXTERNAL NAME "HUBACE.PKG_CONTROL.SP_GET_MAPEO";

------

/*
* Crea a partir de una lista nombres de campos
*/
CREATE PROCEDURE crearNombreCampos(IN refCampo REFERENCE, IN refSalida REFERENCE)
BEGIN

	DECLARE refField REFERENCE TO refCampo.Config[1];

	WHILE LASTMOVE(refField) DO
		SET refSalida.{refField.ATTRIBUTE} = refField.VALUE;
		MOVE refField NEXTSIBLING;
	END WHILE;

END;


CREATE PROCEDURE setOutputHeaderProperties (IN RefOutputRoot 		REFERENCE, 
											IN MessageFormatParam 	CHARACTER,
											IN EncodingParam		INTEGER,
											IN CodedCharSetIdParam	INTEGER,
											IN PersistenceParam		BOOLEAN)
BEGIN
		SET RefOutputRoot.Properties.MessageFormat 	= MessageFormatParam;
		SET RefOutputRoot.Properties.Encoding		= EncodingParam;
		SET RefOutputRoot.Properties.CodedCharSetId = CodedCharSetIdParam;
		SET RefOutputRoot.Properties.Persistence	= PersistenceParam;
END;


CREATE PROCEDURE setOutputHeaderMQMD (IN RefOutputRoot 	REFERENCE, 
									  IN CorrelIdParam	BLOB, 
									  IN MsgIdParam		BLOB,												
									  IN inEncoding		INTEGER,
									  IN inCCSID		INTEGER)
BEGIN		
		SET RefOutputRoot.MQMD.MsgId    		= MsgIdParam;		
		SET RefOutputRoot.MQMD.CorrelId 		= CorrelIdParam;
		SET RefOutputRoot.MQMD.Encoding			= inEncoding;
		SET RefOutputRoot.MQMD.CodedCharSetId	= inCCSID;
			
END;


CREATE PROCEDURE setOutputHeaderRFH2 (IN refOutUsr 		REFERENCE, 
									  IN idProtocolo	CHARACTER,
									  IN tipoProtocolo	CHARACTER,
									  IN msgId			BLOB,
									  IN inEnconding	INTEGER,
									  IN inCCSID		INTEGER,
									  IN RequestIdentifier BLOB,
									  IN IP				CHARACTER,
									  IN PutApplName	CHARACTER)
BEGIN
	  
	SET refOutUsr.inEncoding 	= inEnconding;
	SET refOutUsr.inCCSID 		= inCCSID; 
			
	CREATE LASTCHILD OF refOutUsr.Parametros			NAME 'Protocolo';
	CREATE LASTCHILD OF refOutUsr.Parametros			NAME 'Servicio';
	CREATE LASTCHILD OF refOutUsr.Parametros.Servicio 	NAME 'Datos';
	
	DECLARE refParamPro 	REFERENCE TO refOutUsr.Parametros.Protocolo;
	DECLARE refParamDatos 	REFERENCE TO refOutUsr.Parametros.Servicio.Datos;
	
	SET refParamPro.IdProtocolo			= idProtocolo;
	SET refParamPro.TipoProtocolo		= tipoProtocolo;
	
	SET refParamDatos.MsgId				= msgId;
	SET refParamDatos.CorrelId			= msgId;
	SET refParamDatos.PutApplName		= PutApplName;
	SET refParamDatos.Encoding			= inEnconding;
	SET refParamDatos.CodedCharSetId	= inCCSID;
	SET refParamDatos.RequestIdentifier = RequestIdentifier;
	SET refParamDatos.IP				= IP;
			
END;


/*
* Procedimiento que crea la estructura PS9 de peticiÃ³n hacia host
*
*/
CREATE PROCEDURE BuildPS9Request(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= determinarValorTransCodeHost(refIntegRequest);--'VLA2';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= '314';	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;
CREATE PROCEDURE BuildPS9Request_Rvalusu(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLA0';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= getLengthTramaPS9(longMsjHost);	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;
CREATE PROCEDURE BuildPS9Request_CCLIS(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	                      --COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	                       --getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';                        --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';	                 	--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLA3';                         --getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 	                  	--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= '306';            	        --'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		                       --COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		                      --COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		                       --COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		                           --COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		                       --COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			                                   --FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Cfacs(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VL4';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= '326';	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Cordscli(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLAA';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= longMsjHost;	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Cdetord(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLAB';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= '306';	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Rordneg(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLAR';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= longMsjHost;	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Csalstival(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLA5';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= longMsjHost;	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Pordvenval(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLA8';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= longMsjHost;	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE BuildPS9Request_Cbrok(IN refOutputRoot REFERENCE,
								IN refParamOperation REFERENCE,
								IN chrTramaTxRq CHARACTER, 
								IN refParamGeneric REFERENCE,
								IN refCodService CHARACTER,
								IN refEnv REFERENCE)

BEGIN 
	
	--Declaracion de variables
	DECLARE refMsgPS9 		REFERENCE TO refOutputRoot;
	DECLARE refMsgIH 		REFERENCE TO refOutputRoot;
	DECLARE refMsgME 		REFERENCE TO refOutputRoot;
	DECLARE refIntegRequest	REFERENCE TO refEnv.Backup.TramaJson.JSON.Data.integrationRequest;
	DECLARE longMsjHost 	INTEGER LENGTH(COALESCE(chrTramaTxRq, ''));
	DECLARE tipoFormatoTerminal CHARACTER COALESCE(FIELDVALUE(refParamOperation.TIPO_TERMINAL), 'FA');
	DECLARE nameOperation REFERENCE TO refIntegRequest.requestHeader.idOperacion;

	SET refEnv.Data.longMsjHost = longMsjHost;

	DECLARE al CHARACTER COALESCE(FIELDVALUE(refParamOperation.RANDOM_NRO_SECUENCE), 'N');
	
	CREATE LASTCHILD OF refOutputRoot AS refMsgPS9 NAME 'PS9MsgIN';
	CREATE LASTCHILD OF refMsgPS9 NAME 'ESPACIO_FIJO' VALUE '';
	CREATE LASTCHILD OF refMsgPS9 AS refMsgIH NAME 'IH';
	
	SET refMsgIH.ID_PROTOCOLO 		= '26'; 	--COALESCE(FIELDVALUE(refParamOperation.IH_IDENTIFICADOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TERMINAL_LOGICO 	= '88%0'; 	--getTerminalApp(refCodService, FIELDVALUE(refParamGeneric.URL_APP_TERMINAL));
	SET refMsgIH.TERMINAL_CONTABLE 	= '88%0';   --COALESCE(FIELDVALUE(refParamOperation.IH_TERMINAL_CONTABLE), getEMPTY_CHARACTER());
	SET refMsgIH.USUARIO 			= refIntegRequest.requestHeader.usuario; --'P004718';	--COALESCE(FIELDVALUE(refParamOperation.IH_USUARIO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.NUMERO_SECUENCIA 	= '00000000';		--getSecuenciaPS9();
	SET refMsgIH.TRANS_CODE_HOST 	= 'VLAN';--getNamespaceOperation(nameOperation);----	OperationNam;	--COALESCE(FIELDVALUE(refParamOperation.IH_CODIGO_TRANSACCION), getEMPTY_CHARACTER());	
	SET refMsgIH.OPCION_APLICACION 	= '00'; 		--'00';ACE		--COALESCE(FIELDVALUE(refParamOperation.IH_OPCION_APLICACION_USER), getEMPTY_CHARACTER());
	SET refMsgIH.LONGITUD_TRAMA 	= longMsjHost;	--'00126'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LONGITUD_TRAMA), getEMPTY_CHARACTER());
	SET refMsgIH.INDICADOR_COMMIT 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_COMMIT_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_MENSAJE_IN 	= '1'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_MENSAJE_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.TIPO_PROCESO 		= 'O'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_TIPO_PROCESO_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.CANAL_COMUNICACION = refIntegRequest.requestHeader.canal;	--'VL'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_CANAL), getEMPTY_CHARACTER());
	SET refMsgIH.IND_PRE_FORMATO 	= 'N'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_INDICADOR_PREFOR_PROTOCOLO), getEMPTY_CHARACTER());
	SET refMsgIH.LENGUAJE 			= 'R'; 		--COALESCE(FIELDVALUE(refParamOperation.IH_LENGUAJE_PROTOCOLO), getEMPTY_CHARACTER());
	
	CREATE LASTCHILD OF refMsgPS9 AS refMsgME NAME 'ME';
	
	SET refMsgME.LONGITUD_MENSAJE = longMsjHost;
	SET refMsgME.TIPO_MENSAJE = '1'; 			--FIELDVALUE(refParamOperation.ME_TIPO_MENSAJE_PROTOCOLO);
	SET refMsgME.MENSAJE = chrTramaTxRq;
	
END;

CREATE PROCEDURE setOutputConfigProperties (IN refOutputRoot 	REFERENCE, 
											IN messageSet 		CHARACTER,
											IN messageType		CHARACTER,
											IN messageFormat	CHARACTER,
											IN replyProtocol	CHARACTER,
											IN contentType		CHARACTER)
BEGIN
		
		SET refOutputRoot.Properties.MessageSet 	= messageSet;
		SET refOutputRoot.Properties.MessageType 	= messageType;
		SET refOutputRoot.Properties.MessageFormat 	= messageFormat;
		SET refOutputRoot.Properties.ReplyProtocol	= replyProtocol;
		SET refOutputRoot.Properties.ContentType	= contentType;
END;

CREATE PROCEDURE setOutputConfigMQMD (IN refEnv REFERENCE,
									  IN refOutputRoot 	REFERENCE, 
									  IN refParamOpera	REFERENCE, 
									  IN msgId			BLOB,												
									  IN REPLY_TO_QMGR	CHARACTER)
BEGIN
		
		DECLARE nameQmgr CHARACTER ''; --getEMPTY_CHARACTER();
    	SET nameQmgr = COALESCE(refParamOpera.REPLY_TO_QMGR, ''); --getEMPTY_CHARACTER());
    		
    	IF CONTAINS(nameQmgr, '**') THEN
    		SET nameQmgr = REPLACE(nameQmgr, '**', REPLY_TO_QMGR);
    	END IF;
		
		SET refOutputRoot.MQMD.Encoding			= 465; --CAST(COALESCE(refParamOpera.ENCODING, 273) AS INTEGER);
		SET refOutputRoot.MQMD.CodedCharSetId   = 500;
		SET refOutputRoot.MQMD.Format			= 'MQSTR'; --COALESCE(refParamOpera.FORMAT, MQFMT_STRING);
		SET refOutputRoot.MQMD.Version			= CAST(COALESCE(refParamOpera.VERSION, 2) AS INTEGER);
		SET refOutputRoot.MQMD.Report			= CAST(COALESCE(refParamOpera.REPORT, 0) AS INTEGER);
		SET refOutputRoot.MQMD.MsgType			= CAST(COALESCE(refParamOpera.MSG_TYPE, 8) AS INTEGER);
		SET refOutputRoot.MQMD.Expiry			= CAST(COALESCE(refParamOpera.EXPIRY, -1) AS INTEGER);
		SET refOutputRoot.MQMD.Feedback			= CAST(COALESCE(refParamOpera.FEED_BACK, 0) AS INTEGER);
		SET refOutputRoot.MQMD.Priority			= CAST(COALESCE(refParamOpera.PRIORITY, -1) AS INTEGER);
		SET refOutputRoot.MQMD.Persistence		= CAST(COALESCE(refParamOpera.PERSISTENCE, 1) AS INTEGER);
		SET refOutputRoot.MQMD.MsgId			= msgId;
		SET refOutputRoot.MQMD.CorrelId			= msgId;
--		SET refOutputRoot.MQMD.ReplyToQ			= COALESCE(refParamOpera.REPLY_TO_Q, getEMPTY_CHARACTER());
		SET refOutputRoot.MQMD.ReplyToQ			= 'QLT.ECS2.RESP';
		SET refOutputRoot.MQMD.ReplyToQMgr		= 'TMDW5'; --nameQmgr;
		
		SET refEnv.Data.Format					= COALESCE(refOutputRoot.MQMD.Format,'MQSTR_X' );
END;

--17/02/2024
CREATE PROCEDURE buildResClient_WP_RIW3_OK(IN refRoot REFERENCE,
										   IN refInPS9 REFERENCE,
										   IN refJsonIn REFERENCE)
BEGIN
	
	CREATE LASTCHILD OF refRoot NAME 'integrationResponse';
	DECLARE refIntegrationResp REFERENCE TO refRoot.integrationResponse;
	
	CALL buildHeaderResponse(refIntegrationResp, refJsonIn, getNO(), getNO(), getEMPTY_CHARACTER(), getEMPTY_CHARACTER());
	
	--CREATE LASTCHILD OF refIntegrationResp NAME 'responseHeader';
	--DECLARE refResponseHeader REFERENCE TO refIntegrationResp.responseHeader;
	
	CREATE LASTCHILD OF refIntegrationResp NAME 'responseBody';
	DECLARE refResponseBody REFERENCE TO refIntegrationResp.responseBody;
	
	DECLARE refBody REFERENCE TO refInPS9.OC[1];
	
	--Se arma la cabecera
	--SET refResponseHeader.idSesion			= COALESCE(refJsonIn.idSesion, getEMPTY_CHARACTER());
	--SET refResponseHeader.idPeticionEmpresa	= COALESCE(refJsonIn.idPeticionEmpresa, getEMPTY_CHARACTER());
	--SET refResponseHeader.idPeticionBanco	= COALESCE(refJsonIn.idPeticionBanco, getEMPTY_CHARACTER());
	--SET refResponseHeader.idOperacion		= COALESCE(refJsonIn.idOperacion, getEMPTY_CHARACTER());
	--SET refResponseHeader.codigoServicio	= getCOD_RPTA_OK();
 	--SET refResponseHeader.mensajeServicio	= getDES_RPTA_OK();
 	--SET refResponseHeader.estadoServicio	= getEST_RPTA_OK();
 	
 	--Se arma el cuerpo
 	WHILE LASTMOVE(refBody) DO
	 	IF SUBSTRING(refBody FROM 1 FOR 10) = 'B1RIMSRIW3' THEN
		 	SET refResponseBody.tipoPersona			= TRIM(COALESCE(SUBSTRING(refBody FROM 26 FOR 3), getEMPTY_CHARACTER()));
	    	SET refResponseBody.numDocumento		= TRIM(COALESCE(SUBSTRING(refBody FROM 32 FOR 11), getEMPTY_CHARACTER()));
	    	SET refResponseBody.codDocumento		= TRIM(COALESCE(SUBSTRING(refBody FROM 46 FOR 1), getEMPTY_CHARACTER()));
	    	SET refResponseBody.razonSocial			= TRIM(COALESCE(SUBSTRING(refBody FROM 50 FOR 60), getEMPTY_CHARACTER()));
	    	SET refResponseBody.oficinaCliente		= TRIM(COALESCE(SUBSTRING(refBody FROM 113 FOR 4), getEMPTY_CHARACTER()));
	    	SET refResponseBody.descOficinaCliente	= TRIM(COALESCE(SUBSTRING(refBody FROM 120 FOR 35), getEMPTY_CHARACTER()));
	    	SET refResponseBody.codGestorCli		= TRIM(COALESCE(SUBSTRING(refBody FROM 158 FOR 8), getEMPTY_CHARACTER()));
	    	SET refResponseBody.nombreGestor		= TRIM(COALESCE(SUBSTRING(refBody FROM 169 FOR 25), getEMPTY_CHARACTER()));
	    	SET refResponseBody.tecomCliente		= TRIM(COALESCE(SUBSTRING(refBody FROM 197 FOR 5), getEMPTY_CHARACTER()));
	    	SET refResponseBody.desCEtiqueta		= TRIM(COALESCE(SUBSTRING(refBody FROM 205 FOR 19), getEMPTY_CHARACTER()));
	    	SET refResponseBody.codCentral			= TRIM(COALESCE(SUBSTRING(refBody FROM 227 FOR 8), getEMPTY_CHARACTER()));
	    	SET refResponseBody.codActivCli			= TRIM(COALESCE(SUBSTRING(refBody FROM 238 FOR 11), getEMPTY_CHARACTER()));
	    	SET refResponseBody.desActividad		= TRIM(COALESCE(SUBSTRING(refBody FROM 252 FOR 45), getEMPTY_CHARACTER()));
	    	SET refResponseBody.clasifBanco			= TRIM(COALESCE(SUBSTRING(refBody FROM 300 FOR 16), getEMPTY_CHARACTER()));
	    	SET refResponseBody.clasifSistFinanc	= TRIM(COALESCE(SUBSTRING(refBody FROM 319 FOR 16), getEMPTY_CHARACTER()));
	    	SET refResponseBody.buro				= TRIM(COALESCE(SUBSTRING(refBody FROM 338 FOR 2), getEMPTY_CHARACTER()));
	    	SET refResponseBody.fechaNac			= TRIM(COALESCE(SUBSTRING(refBody FROM 343 FOR 10), getEMPTY_CHARACTER()));
	    	SET refResponseBody.dirCliente			= TRIM(COALESCE(SUBSTRING(refBody FROM 356 FOR 90), getEMPTY_CHARACTER()));
	    	SET refResponseBody.prefTelef			= TRIM(COALESCE(SUBSTRING(refBody FROM 449 FOR 3), getEMPTY_CHARACTER()));
	    	SET refResponseBody.numTelef			= TRIM(COALESCE(SUBSTRING(refBody FROM 455 FOR 9), getEMPTY_CHARACTER()));
	    	SET refResponseBody.numEntidades		= TRIM(COALESCE(SUBSTRING(refBody FROM 467 FOR 3), getEMPTY_CHARACTER()));
	    	SET refResponseBody.edad				= TRIM(COALESCE(SUBSTRING(refBody FROM 473 FOR 3), getEMPTY_CHARACTER()));
	    	SET refResponseBody.periodoRating		= TRIM(COALESCE(SUBSTRING(refBody FROM 479 FOR 6), getEMPTY_CHARACTER()));
	    	SET refResponseBody.puntRating			= TRIM(COALESCE(SUBSTRING(refBody FROM 488 FOR 8), getEMPTY_CHARACTER()));
	    	SET refResponseBody.escRating			= TRIM(COALESCE(SUBSTRING(refBody FROM 499 FOR 5), getEMPTY_CHARACTER()));
	    	SET refResponseBody.sobreendeu			= RTRIM(COALESCE(SUBSTRING(refBody FROM 507 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.impagos				= TRIM(COALESCE(SUBSTRING(refBody FROM 530 FOR 1), getEMPTY_CHARACTER()));
	    	SET refResponseBody.inelegibles			= TRIM(COALESCE(SUBSTRING(refBody FROM 534 FOR 30), getEMPTY_CHARACTER()));
	    	SET refResponseBody.riesgoAct			= RTRIM(COALESCE(SUBSTRING(refBody FROM 567 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.tipoCambio			= RTRIM(COALESCE(SUBSTRING(refBody FROM 590 FOR 16), getEMPTY_CHARACTER()));
	    	SET refResponseBody.codGrupEco			= TRIM(COALESCE(SUBSTRING(refBody FROM 609 FOR 8), getEMPTY_CHARACTER()));
	    	SET refResponseBody.nomGrupo			= TRIM(COALESCE(SUBSTRING(refBody FROM 620 FOR 50), getEMPTY_CHARACTER()));
	    	SET refResponseBody.periodoSisFin		= TRIM(COALESCE(SUBSTRING(refBody FROM 673 FOR 6), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudSisFin			= RTRIM(COALESCE(SUBSTRING(refBody FROM 682 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaBanco			= RTRIM(COALESCE(SUBSTRING(refBody FROM 705 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaSeguro			= RTRIM(COALESCE(SUBSTRING(refBody FROM 728 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.correo				= TRIM(COALESCE(SUBSTRING(refBody FROM 751 FOR 80), getEMPTY_CHARACTER()));
	    	SET refResponseBody.dcastsf				= RTRIM(COALESCE(SUBSTRING(refBody FROM 834 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.dcastbc				= RTRIM(COALESCE(SUBSTRING(refBody FROM 857 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.propyme				= TRIM(COALESCE(SUBSTRING(refBody FROM 880 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.ubigeo				= TRIM(COALESCE(SUBSTRING(refBody FROM 903 FOR 7), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaDirectaSF		= RTRIM(COALESCE(SUBSTRING(refBody FROM 913 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaIndirectaSF	= RTRIM(COALESCE(SUBSTRING(refBody FROM 936 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaDirectaBanco	= RTRIM(COALESCE(SUBSTRING(refBody FROM 959 FOR 20), getEMPTY_CHARACTER()));
	    	SET refResponseBody.deudaIndirectaBanco	= RTRIM(COALESCE(SUBSTRING(refBody FROM 982 FOR 20), getEMPTY_CHARACTER()));
	 	END IF;
		MOVE refBody NEXTSIBLING;
 	END WHILE;
 	
END;

CREATE PROCEDURE buildHeaderResponse(INOUT refIntegrationResp REFERENCE,
									 IN refJsonIn REFERENCE,
									 IN isError CHARACTER,
									 IN isErrorHost CHARACTER,
									 IN chrCodigoError CHARACTER,
									 IN chrDescripcionError CHARACTER)
BEGIN
	
	CREATE LASTCHILD OF refIntegrationResp NAME 'responseHeader';
	DECLARE refResponseHeader REFERENCE TO refIntegrationResp.responseHeader;
	
	--Se arma la cabecera
	SET refResponseHeader.idSesion			= COALESCE(refJsonIn.idSesion, getEMPTY_CHARACTER());
	SET refResponseHeader.idPeticionEmpresa	= COALESCE(refJsonIn.idPeticionEmpresa, getEMPTY_CHARACTER());
	SET refResponseHeader.idPeticionBanco	= COALESCE(refJsonIn.idPeticionBanco, getEMPTY_CHARACTER());
	SET refResponseHeader.idOperacion		= COALESCE(refJsonIn.idOperacion, getEMPTY_CHARACTER());
	
	IF isError = getNO() THEN
		SET refResponseHeader.codigoServicio	= getCOD_RPTA_OK();
	 	SET refResponseHeader.mensajeServicio	= getDES_RPTA_OK();
	 	SET refResponseHeader.estadoServicio	= getEST_RPTA_OK();
	ELSE
		IF isErrorHost = getNO() THEN
		 	SET refResponseHeader.codigoServicio	= getCOD_RPTA_ERROR();
		 	SET refResponseHeader.mensajeServicio	= chrCodigoError || chrDescripcionError;
		ELSE
		 	SET refResponseHeader.codigoServicio	= chrCodigoError;
		 	SET refResponseHeader.mensajeServicio	= chrDescripcionError;
		END IF;
		SET refResponseHeader.estadoServicio	= getEST_RPTA_ERROR();
	END IF;
	
END;

CREATE PROCEDURE buildResClient_WP_RIW_ERROR(IN refRoot REFERENCE,
										      IN refJsonIn REFERENCE,
										      IN isErrorHost CHARACTER,
										      IN chrCodigoError CHARACTER,
										      IN chrDescripcionError CHARACTER)
BEGIN
	
	CREATE LASTCHILD OF refRoot NAME 'XMLNSC';
	CREATE LASTCHILD OF refRoot.XMLNSC NAME 'integrationResponse';
	DECLARE refIntegrationResp REFERENCE TO refRoot.XMLNSC.integrationResponse;
	
	CALL buildHeaderResponse(refIntegrationResp, refJsonIn, getSI(), isErrorHost, chrCodigoError, chrDescripcionError);
	
	--CREATE LASTCHILD OF refIntegrationResp NAME 'responseHeader';
	--DECLARE refResponseHeader REFERENCE TO refIntegrationResp.responseHeader;
	
	--SET refResponseHeader.idSesion 				= COALESCE(refJsonIn.idSesion, getEMPTY_CHARACTER());
	--SET refResponseHeader.idPeticionEmpresa		= COALESCE(refJsonIn.idPeticionEmpresa, getEMPTY_CHARACTER());
	--SET refResponseHeader.idPeticionBanco		= COALESCE(refJsonIn.idPeticionBanco, getEMPTY_CHARACTER());
	--SET refResponseHeader.idOperacion			= COALESCE(refJsonIn.idOperacion, getEMPTY_CHARACTER());
	
	--IF isErrorHost = getNO() THEN
	-- 	SET refResponseHeader.codigoServicio	= getCOD_RPTA_ERROR();
	-- 	SET refResponseHeader.mensajeServicio	= chrCodigoError || chrDescripcionError;
	--ELSE
	-- 	SET refResponseHeader.codigoServicio	= chrCodigoError;
	-- 	SET refResponseHeader.mensajeServicio	= chrDescripcionError;
	--END IF;
 	
 	--SET refResponseHeader.estadoServicio		= getEST_RPTA_ERROR();
	
	CREATE LASTCHILD OF refIntegrationResp NAME 'responseBody';
	
END;

